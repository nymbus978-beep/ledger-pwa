<!doctype html>
<html lang="spa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ðŸ“’ Libro de caja (Offline)</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", sans-serif; }
    body { margin:0; background:#f6f7f9; color:#111; }
    header { position:sticky; top:0; background:#fff; padding:14px 16px; box-shadow:0 1px 8px rgba(0,0,0,.06); z-index:10; }
    header h1 { margin:0; font-size:18px; }
    main { padding:14px 12px 40px; max-width:900px; margin:0 auto; }

    .card { background:#fff; border-radius:14px; padding:14px; margin:12px 0; box-shadow:0 2px 12px rgba(0,0,0,.06); }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .col { flex:1 1 160px; }

    label { font-size:12px; color:#555; display:block; margin-bottom:6px; }
    input, select, textarea, button {
      width:100%; box-sizing:border-box;
      padding:12px; border-radius:12px; border:1px solid #d7dbe0;
      font-size:15px; background:#fff;
    }
    textarea { min-height:90px; resize:vertical; }

    .btn { background:#111; color:#fff; border:none; font-weight:700; }
    .btn2 { background:#fff; color:#111; border:1px solid #d7dbe0; font-weight:600; }
    .btn:disabled { opacity:.5; }

    .muted { font-size:12px; color:#666; line-height:1.5; }
    .tiny { font-size:11px; color:#777; }

    .imgPrev { display:none; width:100%; max-height:220px; object-fit:cover; border-radius:12px; border:1px solid #e6e9ee; margin-top:8px; }

    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { padding:10px 8px; border-bottom:1px solid #eef1f4; }
    th { font-size:12px; color:#666; text-align:left; }
    .right { text-align:right; }
    .ok { color:#0b6b2a; }
    .danger { color:#b00020; }

    .totals { display:flex; gap:10px; flex-wrap:wrap; }
    .stat { flex:1 1 160px; border:1px solid #eceff3; border-radius:14px; padding:12px; cursor:pointer; }
    .stat.active { border:2px solid #111; }

    .overlay {
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    .panel {
      background:#fff; border-radius:16px; padding:18px; width:min(420px,100%);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .langBtn {
      width:100%; padding:14px; border-radius:14px; border:1px solid #d7dbe0;
      background:#fff; text-align:left; margin-top:10px;
    }
  </style>
</head>

<body>

<!-- Language chooser -->
<div id="langOverlay" class="overlay">
  <div class="panel">
    <h2>Choose language</h2>
    <button class="langBtn" data-lang="es"><b>EspaÃ±ol</b><br/><span class="tiny">Predeterminado</span></button>
    <button class="langBtn" data-lang="en"><b>English</b></button>
    <button class="langBtn" data-lang="ko"><b>í•œêµ­ì–´</b></button>
  </div>
</div>

<header>
  <h1 id="title">ðŸ“’ Libro de caja (Offline)</h1>
</header>

<main>

<!-- OCR / Receipt -->
<section class="card">
  <label>Foto del recibo</label>
  <input id="file" type="file" accept="image/*" capture="environment" />
  <img id="preview" class="imgPrev" />

  <div class="row" style="margin-top:10px;">
    <div class="col"><button id="btnOCR" class="btn2">Ejecutar OCR (opcional)</button></div>
    <div class="col"><button id="btnClearOCR" class="btn2">Borrar OCR</button></div>
  </div>

  <p class="muted" id="ocrHint">
    â€¢ OCR es opcional. Guarda sin esperar.<br/>
    â€¢ Optimizado: recorte inferior 40% + resize.<br/>
    â€¢ Idioma OCR: EspaÃ±ol (spa).
  </p>

  <div class="tiny" id="ocrStatus"></div>

  <label style="margin-top:10px;">Texto OCR</label>
  <textarea id="ocrText" placeholder="Resultado OCR (opcional)"></textarea>

  <div class="row" style="margin-top:10px;">
    <div class="col"><button id="btnApplyOCR" class="btn2" disabled>Aplicar OCR</button></div>
  </div>
</section>

<!-- Manual entry -->
<section class="card">
  <h3>Ingreso / Gasto</h3>
  <div class="row">
    <div class="col">
      <label>Tipo</label>
      <select id="type">
        <option value="expense">Gasto</option>
        <option value="income">Ingreso</option>
      </select>
    </div>
    <div class="col">
      <label>Fecha</label>
      <input id="date" type="date" />
    </div>
    <div class="col">
      <label>Monto</label>
      <input id="amount" type="number" />
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="col">
      <label>Memo</label>
      <input id="memo" type="text" />
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="col"><button id="btnSave" class="btn">Guardar (sin OCR)</button></div>
  </div>
</section>

<!-- Daily totals -->
<section class="card">
  <h3>Totales diarios</h3>
  <div class="totals" id="summary"></div>

  <h3 style="margin-top:14px;">Registros</h3>
  <table>
    <thead>
      <tr><th>Fecha</th><th>Tipo</th><th>Memo</th><th class="right">Monto</th></tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</section>

</main>

<script>
/* ===========================
   Local storage
=========================== */
const KEY = "ledger.v1";
let items = JSON.parse(localStorage.getItem(KEY) || "[]");

/* ===========================
   Helpers
=========================== */
const $ = id => document.getElementById(id);
const today = () => new Date().toISOString().slice(0,10);
$("date").value = today();

function saveItems() {
  localStorage.setItem(KEY, JSON.stringify(items));
  render();
}
function render() {
  const rows = $("rows");
  rows.innerHTML = "";
  const sum = {};
  items.forEach(it => {
    sum[it.date] = sum[it.date] || { income:0, expense:0 };
    sum[it.date][it.type] += it.amount;

    rows.innerHTML += `
      <tr>
        <td>${it.date}</td>
        <td class="${it.type==="income"?"ok":"danger"}">${it.type}</td>
        <td>${it.memo||""}</td>
        <td class="right">${it.amount}</td>
      </tr>`;
  });

  const s = $("summary");
  s.innerHTML = "";
  Object.keys(sum).sort().reverse().forEach(d => {
    const net = sum[d].income - sum[d].expense;
    s.innerHTML += `
      <div class="stat">
        <div class="tiny">${d}</div>
        <b>${net}</b>
      </div>`;
  });
}
render();

/* ===========================
   Save without OCR
=========================== */
$("btnSave").onclick = () => {
  const a = Number($("amount").value);
  if (!a) return alert("Monto invÃ¡lido");
  items.push({
    id: crypto.randomUUID(),
    date: $("date").value,
    type: $("type").value,
    amount: a,
    memo: $("memo").value
  });
  $("amount").value = "";
  $("memo").value = "";
  saveItems();
};

/* ===========================
   OCR (Spanish only, optimized)
=========================== */
let T = null;
async function loadTesseract() {
  if (T) return T;
  await new Promise(res => {
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
    s.onload = res;
    document.head.appendChild(s);
  });
  T = window.Tesseract;
  return T;
}

async function preprocess(file) {
  const bmp = await createImageBitmap(file);
  const scale = 1200 / bmp.width;
  const w = 1200;
  const h = bmp.height * scale;

  const c = document.createElement("canvas");
  c.width = w;
  c.height = h;
  const ctx = c.getContext("2d");
  ctx.drawImage(bmp, 0, 0, w, h);

  const cropH = h * 0.4;
  const cc = document.createElement("canvas");
  cc.width = w;
  cc.height = cropH;
  cc.getContext("2d").drawImage(c, 0, h-cropH, w, cropH, 0, 0, w, cropH);

  return new Promise(r => cc.toBlob(r, "image/jpeg", 0.8));
}

$("btnOCR").onclick = async () => {
  const f = $("file").files[0];
  if (!f) return alert("Selecciona una foto");

  $("btnOCR").disabled = true;
  $("ocrStatus").textContent = "OCR en progreso...";

  // â± 8ì´ˆ ì§€ì—° ì•ˆë‚´
  const slowTimer = setTimeout(() => {
    $("ocrStatus").textContent =
      "â³ OCR estÃ¡ tardando. Puedes GUARDAR ahora y ejecutar OCR mÃ¡s tarde.";
  }, 8000);

  try {
    const Tz = await loadTesseract();
    const blob = await preprocess(f);

    const r = await Tz.recognize(blob, "spa");
    $("ocrText").value = r.data.text || "";
    $("ocrStatus").textContent = "OCR listo";
    $("btnApplyOCR").disabled = false;
  } catch(e) {
    alert("OCR error");
  } finally {
    clearTimeout(slowTimer);
    $("btnOCR").disabled = false;
  }
};

$("btnApplyOCR").onclick = () => {
  if (!$("memo").value) {
    $("memo").value = $("ocrText").value.split("\n")[0] || "";
  }
};

$("btnClearOCR").onclick = () => {
  $("ocrText").value = "";
  $("ocrStatus").textContent = "";
};

/* ===========================
   Preview
=========================== */
$("file").onchange = e => {
  const f = e.target.files[0];
  if (!f) return;
  $("preview").src = URL.createObjectURL(f);
  $("preview").style.display = "block";
};

/* ===========================
   Language
=========================== */
document.querySelectorAll(".langBtn").forEach(b=>{
  b.onclick=()=>{
    $("langOverlay").style.display="none";
  };
});
</script>

</body>
</html>
